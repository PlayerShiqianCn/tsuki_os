# Project Tsuki Os

一个用C和x86汇编语言编写的32位操作系统内核，实现了基本的GUI界面、多进程调度、文件系统、内存管理等功能。（下面内容均为AI生成）（代码有70%为AI生成）

## 项目特点

- **GUI 窗口系统**：支持多窗口管理，具有窗口移动、拖拽、分层显示等功能
- **多进程支持**：实现了简单的进程控制块(PCB)和进程调度机制
- **动态内存管理**：实现了 `malloc` 和 `free`，支持堆内存的动态分配和回收
- **文件系统**：基于 ext2 格式的简易文件系统实现
- **PS/2输入设备**：支持键盘和鼠标输入
- **中断处理**：实现了IDT（中断描述符表）和中断处理
- **磁盘I/O**：支持从磁盘读取和写入
- **定时器**：实现了系统定时器用于进程调度

## 近期更新（2026-02-28）

- **显示系统升级**：从纯 VGA 输出切到 QEMU `stdvga` 的 32 位 VBE 线性帧缓冲，支持 `640x480`、`800x600`、`1024x768` 实时切换
- **动态缩放与减闪烁**：保留 `320x200` 逻辑坐标，但输出会自动缩放到当前物理分辨率；重绘改为脏刷新，减少整屏闪烁
- **系统目录结构**：镜像内新增 `/system` 与 `/image`，系统配置、注册表、库文件和图片资源统一纳入目录管理
- **配置系统**：新增 `/system/config.rtsk`，支持壁纸、开始页、网络参数、屏幕分辨率配置；写入后会立即热重载
- **开始页注册表**：新增 `/system/start.rtsk`，用于持久化 Start 页面应用入口
- **设置应用**：新增 `settings.tsk`，可直接修改配置并立即应用常用设置
- **终端增强**：支持 `sudo`、隐藏文件后缀 `._hid_`、`cd`、当前路径提示符，以及 `ping` / `dns` / `http` 等命令
- **图片查看器**：新增 `image.tsk`，支持从 `/image` 中选择图片并显示
- **JPEG 解码库**：新增 `jpeg.tso`，已支持 `SOF0` baseline JPEG 和 `SOF2` progressive JPEG 真解码
- **文件系统写入**：支持覆盖写已有文件，并用于持久化 `config.rtsk` 和 `start.rtsk`
- **网络栈接通**：接入 `e1000` 网卡，支持基础 `ping`、DNS 查询和 HTTP GET
- **启动加载修正**：bootloader 改为分段读取更大的 `kernel.bin`，避免内核增长后被截断

## 项目结构

### 核心模块

| 文件 | 功能说明 |
|------|---------|
| `kernel.c` | 内核主程序，包含任务栏、开始菜单等GUI逻辑 |
| `kernel_entry.asm` | 内核入口点（汇编） |
| `boot.asm` | 启动引导程序（汇编） |
| `app_entry.asm` | 应用程序入口点（汇编） |

### 内存管理

| 文件 | 功能说明 |
|------|---------|
| `heap.c / heap.h` | 堆内存管理，实现malloc/free功能 |

### 进程管理

| 文件 | 功能说明 |
|------|---------|
| `process.c / process.h` | 进程控制、进程调度 |
| `syscall.c / syscall.h` | 系统调用接口 |

### 图形和窗口系统

| 文件 | 功能说明 |
|------|---------|
| `video.c / video.h` | 显卡初始化和像素绘制 |
| `window.c / window.h` | 窗口管理和绘制 |
| `console.c / console.h` | 控制台输出 |

### 输入设备

| 文件 | 功能说明 |
|------|---------|
| `ps2.c / ps2.h` | PS/2设备驱动（键盘和鼠标） |

### 文件系统与存储

| 文件 | 功能说明 |
|------|---------|
| `fs.c / fs.h` | 文件系统实现（ext2格式） |
| `disk.c / disk.h` | 磁盘I/O操作 |
| `mkfs.c` | 文件系统创建工具 |

### 其他模块

| 文件 | 功能说明 |
|------|---------|
| `idt.c / idt.h` | 中断描述符表设置 |
| `timer.c` | 系统定时器 |
| `pci.c / pci.h` | PCI设备扫描和管理 |
| `audio.c / audio.h` | 音频设备驱动 |
| `net.c / net.h` | 网络模块 |
| `utils.c / utils.h` | 工具函数库 |
| `lib.c / lib.h` | 应用程序库 |
| `app.c` | 示例应用程序 |
| `image_tsk.c` | JPEG 图片查看器应用 |
| `settings_tsk.c` | 系统设置应用 |
| `jpeg.c / jpeg.h` | JPEG 解析与解码库 |
| `font8x8_basic.h` | 8x8像素字体 |

### 链接和配置

| 文件 | 功能说明 |
|------|---------|
| `link.ld` | 链接脚本，定义内存布局 |
| `Makefile` | 项目构建脚本 |

## 关键数据结构

### Window（窗口）
```c
typedef struct Window {
    int id;                    // 窗口ID
    int x, y, w, h;           // 位置和大小
    char* title;              // 标题
    int visible;              // 可见性
    unsigned char bg_color;   // 背景颜色
    unsigned char* back_buffer; // 后台缓冲区
    void (*extra_draw)(struct Window*); // 自定义绘制函数
} Window;
```

### Process（进程）
```c
typedef struct Process {
    int pid;                   // 进程ID
    unsigned int esp;          // 栈指针
    unsigned int stack_base;   // 栈底
    ProcessState state;        // 进程状态
    Window* win;              // 关联窗口
    struct Process* next;     // 下一个进程
} Process;
```

### HeapBlock（堆块）
```c
typedef struct {
    unsigned int size;  // 块大小
    int is_free;       // 是否空闲
    struct HeapBlock* next; // 下一块
} HeapBlock;
```

## 构建和运行

### 系统要求

- Linux/Unix 环境
- `nasm` - x86汇编编译器
- `gcc` - C编译器（32位支持）
- `ld` - GNU链接器
- `qemu-system-i386` - x86模拟器（用于运行OS）

### 编译和运行

```bash
# 编译并生成OS镜像
make

# 在QEMU中运行
make run

# 清理生成文件
make clean
```

### 生成的文件

- `boot.bin` - 启动扇区（512字节）
- `kernel.bin` - 内核二进制
- `kernel.elf` - 内核ELF文件
- `app.tsk` - 应用程序任务文件
- `terminal.tsk` - 终端应用
- `image.tsk` - 图片查看器
- `settings.tsk` - 设置应用
- `os-image.img` - 完整OS镜像（10MB）

## 内存布局

- **0x00000000-0x00000FFF**: 中断向量表（IVT）
- **0x00001000-0x0009FFFF**: 传统RAM
- **0x000A0000-0x000BFFFF**: VGA显存 (0xA0000)
- **0x00100000+**: 内核代码和堆

## 设计亮点

### 1. 图形用户界面 (GUI)
- 支持多窗口显示和管理
- 任务栏和开始菜单
- 鼠标和键盘交互
- 双缓冲技术防止闪烁

### 2. 进程调度
- 简单的进程管理和切换
- 支持进程关联窗口
- 定时器中断驱动调度

### 3. 内存管理
- 链表式堆管理
- 4字节对齐
- 自动块分裂和合并

### 4. 文件系统
- 基于ext2格式
- 支持inode和目录结构
- 支持 `/system`、`/image` 顶层目录
- 支持覆盖写已有文件并触发部分配置热更新
- 可通过 `mkfs` 工具格式化

## 使用说明

### 开始菜单
- 点击任务栏左下角的 "Start" 按钮打开开始菜单
- Start 页面内容由 `/system/start.rtsk` 管理

### 窗口操作
- 点击窗口标题栏可拖动窗口
- 窗口会自动分层显示
- 最后激活的窗口显示在最上层

### 任务栏
- 任务栏显示所有打开的窗口
- 点击任务栏按钮可切换窗口焦点

### 终端
- 默认隐藏系统文件，隐藏文件使用 `._hid_` 后缀
- 使用 `sudo` 可查看和访问隐藏文件
- 支持 `cd` 切换目录，提示符会显示当前路径
- 支持 `ping`、`dns`、`http` 基础网络命令

### 设置与配置
- `/system/config.rtsk` 保存系统配置
- `settings.tsk` 可直接修改壁纸、开始页、网络参数和屏幕模式
- 配置文件写入后会立即在运行中的系统内生效（显示分辨率、壁纸、开始页、网络参数）

## 技术栈

- **语言**: C、x86-32汇编
- **目标平台**: x86 32位PC
- **模拟环境**: QEMU
- **文件系统**: ext2
- **显示模式**: VBE 32位线性帧缓冲（支持 640x480 / 800x600 / 1024x768，当前逻辑坐标仍为 320x200）

## 限制和已知问题

1. 当前应用和窗口系统的逻辑绘制坐标仍是 `320x200`，高分辨率模式通过缩放输出实现
2. 进程调度为简单的轮转调度
3. 文件系统仅支持覆盖写已有文件，不支持完整的文件创建/删除/扩容能力
4. 网络栈目前只覆盖基础功能（`ping` / DNS / 简单 HTTP），不支持 HTTPS/TLS
5. 无虚拟内存支持（无分页）

## 扩展和改进方向

- [ ] 实现虚拟内存和分页
- [ ] 改进进程调度算法
- [ ] 完善文件系统功能
- [ ] 添加更多系统调用
- [ ] 实现设备驱动框架
- [ ] 支持用户态和内核态分离
- [ ] 优化图形渲染性能

## 许可证

见 `LICENSE` 文件

## 作者

该项目是一个教学性的操作系统实现，用于学习和理解操作系统的基本原理。

---

**最后更新**: 2026年2月
